<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MC合成小游戏</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.544.0/dist/umd/lucide.min.js"></script>
    <style>
        body {
            background-color: #8B8B8B;
            font-family: 'Minecraft', sans-serif;
        }
        .crafting-grid {
            display: grid;
            grid-template-columns: repeat(3, 64px);
            grid-template-rows: repeat(3, 64px);
            gap: 4px;
        }
        .grid-cell {
            width: 64px;
            height: 64px;
            background-color: #595959;
            border: 2px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .grid-cell:hover {
            background-color: #696969;
        }
        .result-slot {
            width: 64px;
            height: 64px;
            background-color: #595959;
            border: 2px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .item {
            width: 56px;
            height: 56px;
            image-rendering: pixelated;
            cursor: grab;
        }
        .item-count {
            position: absolute;
            bottom: 2px;
            right: 2px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 1px 4px;
            border-radius: 2px;
            font-size: 12px;
        }
        .item-wrapper {
            position: relative;
            width: 56px;
            height: 56px;
        }
        .inventory {
            display: grid;
            grid-template-columns: repeat(9, 64px);
            gap: 4px;
        }
        .item-button {
            background-color: #595959;
            border: 2px solid #333;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .item-button:hover {
            background-color: #696969;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">
    <div class="text-4xl font-bold mb-8 text-white">MC合成小游戏 - 限定模式</div>
    <a href="index.html" class="absolute top-4 left-4 text-white hover:underline">返回主页</a>
    <div class="flex items-center gap-8">
        <div class="flex flex-col gap-4">
            <button class="item-button" data-item="iron_nugget" onclick="giveItem('iron_nugget', 1)" oncontextmenu="event.preventDefault(); giveItem('iron_nugget', 64)">
                <img src="https://p3-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/9523140e760641868697342784edbe4b.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251227195950049ECA1E3A148F1DDF35&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1767441591&x-signature=DmCqdcw6aSwcpyMe6idabH49w30%3D" alt="铁粒" class="w-12 h-12">
            </button>
            <button class="item-button" data-item="iron_ingot" onclick="giveItem('iron_ingot', 1)" oncontextmenu="event.preventDefault(); giveItem('iron_ingot', 64)">
                <img src="https://p3-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/a74f2b932e904b6fb188496bb47de7e2.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251227195950049ECA1E3A148F1DDF35&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1767441591&x-signature=SPkyy0HvJHZ%2BmTrDpYeAXePFbbo%3D" alt="铁锭" class="w-12 h-12">
            </button>
            <button class="item-button" data-item="iron_block" onclick="giveItem('iron_block', 1)" oncontextmenu="event.preventDefault(); giveItem('iron_block', 64)">
                <img src="https://p3-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/d1483a8f385545d29b561cd374867771.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251227195950049ECA1E3A148F1DDF35&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1767441591&x-signature=B2b9NI%2Fq9nTzf4GW%2F9e4MJsqQI4%3D" alt="铁块" class="w-12 h-12">
            </button>
        </div>
        <div class="crafting-grid" id="crafting-grid">
            <!-- 3x3合成网格 -->
        </div>
        <div class="flex items-center">
            <i data-lucide="arrow-right" class="w-12 h-12 text-white"></i>
        </div>
        <div class="result-slot" id="result-slot">
            <!-- 结果槽 -->
        </div>
    </div>
    <div class="mt-8">
        <div class="text-2xl font-bold mb-4 text-white">物品栏</div>
        <div class="inventory" id="inventory">
            <!-- 物品栏 -->
        </div>
    </div>

    <script>
        const items = [
            { name: 'iron_block', image: 'https://p3-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/d1483a8f385545d29b561cd374867771.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251227195950049ECA1E3A148F1DDF35&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1767441591&x-signature=B2b9NI%2Fq9nTzf4GW%2F9e4MJsqQI4%3D', count: 9 },
            { name: 'iron_ingot', image: 'https://p3-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/a74f2b932e904b6fb188496bb47de7e2.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251227195950049ECA1E3A148F1DDF35&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1767441591&x-signature=SPkyy0HvJHZ%2BmTrDpYeAXePFbbo%3D', count: 9 },
            { name: 'iron_nugget', image: 'https://p3-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/9523140e760641868697342784edbe4b.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251227195950049ECA1E3A148F1DDF35&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1767441591&x-signature=DmCqdcw6aSwcpyMe6idabH49w30%3D', count: 9 },
            { name: 'iron_helmet', image: 'https://p3-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/8e9b742a38db4a58a4e66d38c1524a25.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251231200117245190B9F08102A75E68&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1767787277&x-signature=QC16FeGCYAGGpvc0nYMiMqIpWNQ%3D', count: 0 },
            { name: 'iron_chestplate', image: 'https://p3-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/67af579301194c82ae6374c671032403.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251231200117245190B9F08102A75E68&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1767787277&x-signature=f%2FCt3OKkn9AIkWEN1ygnK308l3M%3D', count: 0 },
            { name: 'iron_leggings', image: 'https://p3-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/145a7e0697c543d4be158dbfdab17eb8.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251231200117245190B9F08102A75E68&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1767787277&x-signature=64IdwkONoBg%2Bd6nEYRuUv4A2xMQ%3D', count: 0 },
            { name: 'iron_boots', image: 'https://p3-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/5742380d08914a089277f90b47f81a2c.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251231200117245190B9F08102A75E68&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1767787277&x-signature=9vpuNYRxsESUecUyY%2FOwoNOjnmU%3D', count: 0 },
            { name: 'anvil', image: 'https://p3-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/ee9361be67924eb0a148e0587b218ef2.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251231200117245190B9F08102A75E68&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1767787277&x-signature=b9B%2Fntfm8AkGlmiWozE%2Batoy%2Bkc%3D', count: 0 },
            { name: 'chain', image: 'https://p3-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/ea35adff06604935b48ea52beb91611e.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251231200117245190B9F08102A75E68&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1767787277&x-signature=O7bognNnY3XmJN9ihLNj7YJ%2Fr4M%3D', count: 0 }
        ];

        const recipes = {
            'iron_block': {
                pattern: [
                    ['iron_ingot', 'iron_ingot', 'iron_ingot'],
                    ['iron_ingot', 'iron_ingot', 'iron_ingot'],
                    ['iron_ingot', 'iron_ingot', 'iron_ingot']
                ],
                result: 'iron_block'
            },
            'iron_ingot': {
                pattern: [
                    ['iron_nugget', 'iron_nugget', 'iron_nugget'],
                    ['iron_nugget', 'iron_nugget', 'iron_nugget'],
                    ['iron_nugget', 'iron_nugget', 'iron_nugget']
                ],
                result: 'iron_ingot'
            },
            'iron_helmet': {
                pattern: [
                    ['iron_ingot', 'iron_ingot', 'iron_ingot'],
                    ['iron_ingot', null, 'iron_ingot'],
                    [null, null, null]
                ],
                result: 'iron_helmet'
            },
            'iron_chestplate': {
                pattern: [
                    ['iron_ingot', null, 'iron_ingot'],
                    ['iron_ingot', 'iron_ingot', 'iron_ingot'],
                    ['iron_ingot', 'iron_ingot', 'iron_ingot']
                ],
                result: 'iron_chestplate'
            },
            'iron_leggings': {
                pattern: [
                    ['iron_ingot', 'iron_ingot', 'iron_ingot'],
                    ['iron_ingot', null, 'iron_ingot'],
                    ['iron_ingot', null, 'iron_ingot']
                ],
                result: 'iron_leggings'
            },
            'iron_boots': {
                pattern: [
                    [null, null, null],
                    ['iron_ingot', null, 'iron_ingot'],
                    ['iron_ingot', null, 'iron_ingot']
                ],
                result: 'iron_boots'
            },
            'anvil': {
                pattern: [
                    ['iron_block', 'iron_block', 'iron_block'],
                    ['iron_block', 'iron_ingot', 'iron_block'],
                    [null, 'iron_ingot', null]
                ],
                result: 'anvil'
            },
            'chain': {
                pattern: [
                    [null, 'iron_ingot', null],
                    ['iron_ingot', null, 'iron_ingot'],
                    [null, 'iron_ingot', null]
                ],
                result: 'chain'
            }
        };

        const craftingGrid = document.getElementById('crafting-grid');
        const resultSlot = document.getElementById('result-slot');
        const inventory = document.getElementById('inventory');

        const inventorySlots = Array(9).fill(null).map(() => ({ item: null, count: 0 }));

        function initCraftingGrid() {
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.classList.add('grid-cell');
                cell.dataset.index = i;
                cell.addEventListener('dragover', handleDragOver);
                cell.addEventListener('drop', handleDrop);
                craftingGrid.appendChild(cell);
            }
        }

        function initInventory() {
            inventory.innerHTML = '';
            for (let i = 0; i < 9; i++) {
                const slot = document.createElement('div');
                slot.classList.add('grid-cell');
                slot.dataset.index = i;
                
                if (i < items.length) {
                    const item = items[i];
                    inventorySlots[i] = { item: item.name, count: item.count };
                    updateInventorySlot(slot, item.name, item.count);
                }

                slot.addEventListener('click', function(event) {
                    const slotIndex = parseInt(this.dataset.index);
                    const slotData = inventorySlots[slotIndex];
                    if (slotData.item) {
                        const emptyCell = Array.from(craftingGrid.children).find(cell => cell.querySelector('.item-wrapper') === null);
                        if (emptyCell) {
                            const itemWrapper = document.createElement('div');
                            itemWrapper.classList.add('item-wrapper');
                            itemWrapper.dataset.item = slotData.item;

                            const itemElement = document.createElement('img');
                            itemElement.src = items.find(i => i.name === slotData.item).image;
                            itemElement.alt = slotData.item;
                            itemElement.classList.add('item');
                            itemElement.draggable = true;
                            itemElement.addEventListener('dragstart', function(e) {
                                const itemWrapper = e.target.closest('.item-wrapper');
                                if (itemWrapper) {
                                    e.dataTransfer.setData('text/plain', itemWrapper.dataset.item);
                                    e.dataTransfer.effectAllowed = 'move';
                                    // 记录是从物品栏拖动的
                                    e.dataTransfer.setData('text/source', 'inventory');
                                    e.dataTransfer.setData('text/slotIndex', slotIndex);
                                }
                            });
                            itemElement.draggable = true;
                            itemElement.addEventListener('dragstart', function(e) {
                                e.dataTransfer.setData('text/plain', slotData.item);
                                e.dataTransfer.effectAllowed = 'move';
                                // 记录是从物品栏拖动的
                                e.dataTransfer.setData('text/source', 'inventory');
                                e.dataTransfer.setData('text/slotIndex', slotIndex);
                            });

                            const countElement = document.createElement('div');
                            countElement.classList.add('item-count');
                            countElement.textContent = '1';

                            itemWrapper.appendChild(itemElement);
                            itemWrapper.appendChild(countElement);

                            itemWrapper.addEventListener('click', function(e) {
                                e.stopPropagation();
                                const itemName = this.dataset.item;
                                const count = parseInt(this.querySelector('.item-count').textContent) || 1;
                                const takeCount = e.button === 2 ? Math.floor(count / 2) : 1;
                                if (takeCount > 0) {
                                    addItemsToInventory(itemName, takeCount);
                                    const remainingCount = count - takeCount;
                                    if (remainingCount <= 0) {
                                        emptyCell.innerHTML = '';
                                    } else {
                                        this.querySelector('.item-count').textContent = remainingCount;
                                    }
                                    checkRecipe();
                                }
                            });
                            itemWrapper.addEventListener('contextmenu', function(e) {
                                e.preventDefault();
                                e.stopPropagation();
                                const itemName = this.dataset.item;
                                const count = parseInt(this.querySelector('.item-count').textContent) || 1;
                                const takeCount = Math.floor(count / 2);
                                if (takeCount > 0) {
                                    addItemsToInventory(itemName, takeCount);
                                    const remainingCount = count - takeCount;
                                    if (remainingCount <= 0) {
                                        emptyCell.innerHTML = '';
                                    } else {
                                        this.querySelector('.item-count').textContent = remainingCount;
                                    }
                                    checkRecipe();
                                }
                            });
                            emptyCell.appendChild(itemWrapper);
                            checkRecipe();

                            slotData.count--;
                            if (slotData.count <= 0) {
                                slotData.item = null;
                                slot.innerHTML = '';
                            } else {
                                updateInventorySlot(slot, slotData.item, slotData.count);
                            }
                        }
                    }
                });
                slot.addEventListener('contextmenu', function(event) {
                    event.preventDefault();
                    const slotIndex = parseInt(this.dataset.index);
                    const slotData = inventorySlots[slotIndex];
                    if (slotData.item) {
                        const emptyCell = Array.from(craftingGrid.children).find(cell => cell.querySelector('.item-wrapper') === null);
                        if (emptyCell) {
                            const itemWrapper = document.createElement('div');
                            itemWrapper.classList.add('item-wrapper');
                            itemWrapper.dataset.item = slotData.item;

                            const itemElement = document.createElement('img');
                            itemElement.src = items.find(i => i.name === slotData.item).image;
                            itemElement.alt = slotData.item;
                            itemElement.classList.add('item');
                            itemElement.draggable = true;
                            itemElement.addEventListener('dragstart', function(e) {
                                const itemWrapper = e.target.closest('.item-wrapper');
                                if (itemWrapper) {
                                    e.dataTransfer.setData('text/plain', itemWrapper.dataset.item);
                                    e.dataTransfer.effectAllowed = 'move';
                                    // 记录是从物品栏拖动的
                                    e.dataTransfer.setData('text/source', 'inventory');
                                    e.dataTransfer.setData('text/slotIndex', slotIndex);
                                }
                            });

                            const countElement = document.createElement('div');
                            countElement.classList.add('item-count');
                            countElement.textContent = slotData.count;

                            itemWrapper.appendChild(itemElement);
                            itemWrapper.appendChild(countElement);

                            itemWrapper.addEventListener('click', function(e) {
                                e.stopPropagation();
                                const itemName = this.dataset.item;
                                const count = parseInt(this.querySelector('.item-count').textContent) || 1;
                                const takeCount = e.button === 2 ? Math.floor(count / 2) : 1;
                                if (takeCount > 0) {
                                    addItemsToInventory(itemName, takeCount);
                                    const remainingCount = count - takeCount;
                                    if (remainingCount <= 0) {
                                        emptyCell.innerHTML = '';
                                    } else {
                                        this.querySelector('.item-count').textContent = remainingCount;
                                    }
                                    checkRecipe();
                                }
                            });
                            itemWrapper.addEventListener('contextmenu', function(e) {
                                e.preventDefault();
                                e.stopPropagation();
                                const itemName = this.dataset.item;
                                const count = parseInt(this.querySelector('.item-count').textContent) || 1;
                                const takeCount = Math.floor(count / 2);
                                if (takeCount > 0) {
                                    addItemsToInventory(itemName, takeCount);
                                    const remainingCount = count - takeCount;
                                    if (remainingCount <= 0) {
                                        emptyCell.innerHTML = '';
                                    } else {
                                        this.querySelector('.item-count').textContent = remainingCount;
                                    }
                                    checkRecipe();
                                }
                            });
                            emptyCell.appendChild(itemWrapper);
                            checkRecipe();

                            slotData.item = null;
                            slotData.count = 0;
                            slot.innerHTML = '';
                        }
                    }
                });

                // 添加数字键1-9选择功能
                document.addEventListener('keydown', function(event) {
                    const key = event.key;
                    if (key >= '1' && key <= '9') {
                        const num = parseInt(key) - 1;
                        if (num === slotIndex) {
                            const slotData = inventorySlots[slotIndex];
                            if (slotData.item) {
                                const emptyCell = Array.from(craftingGrid.children).find(cell => cell.querySelector('.item-wrapper') === null);
                                if (emptyCell) {
                                    const itemWrapper = document.createElement('div');
                                    itemWrapper.classList.add('item-wrapper');
                                    itemWrapper.dataset.item = slotData.item;

                                    const itemElement = document.createElement('img');
                                    itemElement.src = items.find(i => i.name === slotData.item).image;
                                    itemElement.alt = slotData.item;
                                    itemElement.classList.add('item');
                            itemElement.draggable = true;
                            itemElement.addEventListener('dragstart', function(e) {
                                const itemWrapper = e.target.closest('.item-wrapper');
                                if (itemWrapper) {
                                    e.dataTransfer.setData('text/plain', itemWrapper.dataset.item);
                                    e.dataTransfer.effectAllowed = 'move';
                                    // 记录是从物品栏拖动的
                                    e.dataTransfer.setData('text/source', 'inventory');
                                    e.dataTransfer.setData('text/slotIndex', slotIndex);
                                }
                            });

                                    const countElement = document.createElement('div');
                                    countElement.classList.add('item-count');
                                    countElement.textContent = '1';

                                    itemWrapper.appendChild(itemElement);
                                    itemWrapper.appendChild(countElement);

                                    itemWrapper.addEventListener('click', function(e) {
                                        e.stopPropagation();
                                        const itemName = this.dataset.item;
                                        const count = parseInt(this.querySelector('.item-count').textContent) || 1;
                                        const takeCount = e.button === 2 ? Math.floor(count / 2) : 1;
                                        if (takeCount > 0) {
                                            addItemsToInventory(itemName, takeCount);
                                            const remainingCount = count - takeCount;
                                            if (remainingCount <= 0) {
                                                emptyCell.innerHTML = '';
                                            } else {
                                                this.querySelector('.item-count').textContent = remainingCount;
                                            }
                                            checkRecipe();
                                        }
                                    });
                                    itemWrapper.addEventListener('contextmenu', function(e) {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        const itemName = this.dataset.item;
                                        const count = parseInt(this.querySelector('.item-count').textContent) || 1;
                                        const takeCount = Math.floor(count / 2);
                                        if (takeCount > 0) {
                                            addItemsToInventory(itemName, takeCount);
                                            const remainingCount = count - takeCount;
                                            if (remainingCount <= 0) {
                                                emptyCell.innerHTML = '';
                                            } else {
                                                this.querySelector('.item-count').textContent = remainingCount;
                                            }
                                            checkRecipe();
                                        }
                                    });
                                    emptyCell.appendChild(itemWrapper);
                                    checkRecipe();

                                    slotData.count--;
                                    if (slotData.count <= 0) {
                                        slotData.item = null;
                                        slot.innerHTML = '';
                                    } else {
                                        updateInventorySlot(slot, slotData.item, slotData.count);
                                    }
                                }
                            }
                        }
                    }
                });
                inventory.appendChild(slot);
            }
        }

        function updateInventorySlot(slot, itemName, count) {
            slot.innerHTML = '';
            if (itemName && count > 0) {
                const item = items.find(i => i.name === itemName);
                const itemWrapper = document.createElement('div');
                itemWrapper.classList.add('item-wrapper');
                itemWrapper.dataset.item = itemName;
                itemWrapper.draggable = true;
                itemWrapper.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', itemName);
                    e.dataTransfer.effectAllowed = 'move';
                });

                const itemElement = document.createElement('img');
                itemElement.src = item.image;
                itemElement.alt = itemName;
                itemElement.classList.add('item');

                const countElement = document.createElement('div');
                countElement.classList.add('item-count');
                countElement.textContent = count;

                itemWrapper.appendChild(itemElement);
                itemWrapper.appendChild(countElement);
                slot.appendChild(itemWrapper);
            }
        }

        function handleDragStart(e) {
            const itemWrapper = e.target.closest('.item-wrapper');
            if (itemWrapper) {
                e.dataTransfer.setData('text/plain', itemWrapper.dataset.item);
                e.dataTransfer.effectAllowed = 'move';
            }
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        }

        function handleDrop(e) {
            e.preventDefault();
            const draggedItem = e.dataTransfer.getData('text/plain');
            const source = e.dataTransfer.getData('text/source');
            const slotIndex = e.dataTransfer.getData('text/slotIndex');
            
            if (draggedItem) {
                const cell = e.target.closest('.grid-cell');
                if (cell) {
                    // 清除目标格子
                    cell.innerHTML = '';
                    const itemWrapper = document.createElement('div');
                    itemWrapper.classList.add('item-wrapper');
                    itemWrapper.dataset.item = draggedItem;

                    const itemElement = document.createElement('img');
                    itemElement.src = items.find(i => i.name === draggedItem).image;
                    itemElement.alt = draggedItem;
                    itemElement.classList.add('item');
                    itemElement.draggable = true;
                    itemElement.addEventListener('dragstart', handleDragStart);

                    const countElement = document.createElement('div');
                    countElement.classList.add('item-count');
                    countElement.textContent = '1';

                    itemWrapper.appendChild(itemElement);
                    itemWrapper.appendChild(countElement);

                    itemWrapper.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const itemName = this.dataset.item;
                        const count = parseInt(this.querySelector('.item-count').textContent) || 1;
                        const takeCount = e.button === 2 ? Math.floor(count / 2) : 1;
                        if (takeCount > 0) {
                            addItemsToInventory(itemName, takeCount);
                            const remainingCount = count - takeCount;
                            if (remainingCount <= 0) {
                                cell.innerHTML = '';
                            } else {
                                this.querySelector('.item-count').textContent = remainingCount;
                            }
                            checkRecipe();
                        }
                    });
                    itemWrapper.addEventListener('contextmenu', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const itemName = this.dataset.item;
                        const count = parseInt(this.querySelector('.item-count').textContent) || 1;
                        const takeCount = Math.floor(count / 2);
                        if (takeCount > 0) {
                            addItemsToInventory(itemName, takeCount);
                            const remainingCount = count - takeCount;
                            if (remainingCount <= 0) {
                                cell.innerHTML = '';
                            } else {
                                this.querySelector('.item-count').textContent = remainingCount;
                            }
                            checkRecipe();
                        }
                    });
                    cell.appendChild(itemWrapper);
                    checkRecipe();

                    // 如果是从物品栏拖动的，减少物品栏数量
                    if (source === 'inventory' && slotIndex !== '') {
                        const slotData = inventorySlots[parseInt(slotIndex)];
                        slotData.count--;
                        if (slotData.count <= 0) {
                            slotData.item = null;
                            const slotElement = inventory.children[parseInt(slotIndex)];
                            slotElement.innerHTML = '';
                        } else {
                            const slotElement = inventory.children[parseInt(slotIndex)];
                            updateInventorySlot(slotElement, slotData.item, slotData.count);
                        }
                    }
                }
            }
        }
        
        function checkRecipe() {
            const grid = [];
            for (let i = 0; i < 9; i++) {
                const cell = craftingGrid.children[i];
                const itemWrapper = cell.querySelector('.item-wrapper');
                grid.push(itemWrapper ? itemWrapper.dataset.item : null);
            }

            const nonEmptyItems = grid.filter(item => item !== null);

            // 检查分解配方
            if (nonEmptyItems.length === 1) {
                const itemName = nonEmptyItems[0];
                if (itemName === 'iron_block') {
                    const resultItem = items.find(i => i.name === 'iron_ingot');
                    showResult(resultItem.name, 9);
                    return;
                } else if (itemName === 'iron_ingot') {
                    const resultItem = items.find(i => i.name === 'iron_nugget');
                    showResult(resultItem.name, 9);
                    return;
                }
            }

            const grid3x3 = [
                grid.slice(0, 3),
                grid.slice(3, 6),
                grid.slice(6, 9)
            ];

            // 检查合成配方
            for (const [recipeName, recipe] of Object.entries(recipes)) {
                if (comparePatterns(grid3x3, recipe.pattern)) {
                    const resultItem = items.find(i => i.name === recipe.result);
                    showResult(resultItem.name, 1);
                    return;
                }
            }
            
            resultSlot.innerHTML = '';
        }

        function showResult(itemName, count) {
            resultSlot.innerHTML = '';
            const resultItem = items.find(i => i.name === itemName);
            const itemWrapper = document.createElement('div');
            itemWrapper.classList.add('item-wrapper');
            itemWrapper.dataset.item = itemName;
            itemWrapper.dataset.count = count;

            const itemElement = document.createElement('img');
            itemElement.src = resultItem.image;
            itemElement.alt = resultItem.name;
            itemElement.classList.add('item');

            const countElement = document.createElement('div');
            countElement.classList.add('item-count');
            countElement.textContent = count;

            itemWrapper.appendChild(itemElement);
            itemWrapper.appendChild(countElement);
            resultSlot.appendChild(itemWrapper);
        }

        function comparePatterns(grid, pattern) {
            for (let y = 0; y < 3; y++) {
                for (let x = 0; x < 3; x++) {
                    if (pattern[y][x] !== grid[y][x]) {
                        return false;
                    }
                }
            }
            return true;
        }
        
        resultSlot.addEventListener('click', () => {
            const resultWrapper = resultSlot.querySelector('.item-wrapper');
            if (resultWrapper) {
                const resultItemName = resultWrapper.dataset.item;
                const resultCount = parseInt(resultWrapper.dataset.count) || 1;
                addItemsToInventory(resultItemName, resultCount);
                
                resultSlot.innerHTML = '';
                for (let i = 0; i < 9; i++) {
                    craftingGrid.children[i].innerHTML = '';
                }
                checkRecipe();
            }
        });

        function addItemsToInventory(itemName, count) {
            for (let i = 0; i < count; i++) {
                const existingSlot = inventorySlots.findIndex(slot => slot.item === itemName && slot.count < 64);
                if (existingSlot !== -1) {
                    inventorySlots[existingSlot].count++;
                    const slotElement = inventory.children[existingSlot];
                    updateInventorySlot(slotElement, itemName, inventorySlots[existingSlot].count);
                } else {
                    const emptySlot = inventorySlots.findIndex(slot => slot.item === null);
                    if (emptySlot !== -1) {
                        inventorySlots[emptySlot] = { item: itemName, count: 1 };
                        const slotElement = inventory.children[emptySlot];
                        updateInventorySlot(slotElement, itemName, 1);
                    } else {
                        break;
                    }
                }
            }
        }

        function giveItem(itemName, count) {
            addItemsToInventory(itemName, count);
        }

        initCraftingGrid();
        initInventory();
        lucide.createIcons();
    </script>

</body></html>